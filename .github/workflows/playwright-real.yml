# .github/workflows/playwright-real.yml
name: Playwright E2E (Real Stack)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: read

concurrency:
  group: e2e-real-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e_real:
    name: e2e-real (chromium)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    container: mcr.microsoft.com/playwright:v1.56.1-jammy

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet mongodb://localhost:27017/admin --eval 'db.runCommand({ ping: 1 }).ok'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      CI: true
      MOCK_API: "false"
      API_LOGS: "false"

      HOME: /home/pwuser
      DOCKER_CONFIG: /tmp/.docker

      BASE_URL: http://127.0.0.1:5173

      PORT: 3000
      DATABASE_URL: mongodb://mongodb:27017/todolisthafifa_ci_${{ github.run_id }}

      VITE_API_KEY: http://127.0.0.1:3000

    steps:
      - name: Prepare runtime dirs
        run: mkdir -p /tmp/.docker

      - name: Checkout automation
        uses: actions/checkout@v4
        with:
          path: automation

      - name: Checkout backend
        uses: actions/checkout@v4
        with:
          repository: shahafdrori/todolisthafifa-backend
          path: backend

      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: shahafdrori/todolisthafifa-frontend
          path: frontend

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            automation/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install deps (backend)
        working-directory: backend
        run: npm ci

      - name: Install deps (frontend)
        working-directory: frontend
        run: npm ci

      - name: Install deps (automation)
        working-directory: automation
        run: npm ci

      - name: Start backend
        working-directory: backend
        run: |
          nohup npm start > /tmp/backend.log 2>&1 &
          echo $! > /tmp/backend.pid
          sleep 1
          echo "Backend PID: $(cat /tmp/backend.pid)"
          ps -p "$(cat /tmp/backend.pid)" -o pid,cmd || true
          tail -n 60 /tmp/backend.log || true

      - name: Wait for backend
        run: |
          for i in {1..60}; do
            if curl -4 -sSf http://127.0.0.1:3000/tasks/all >/dev/null; then
              echo "Backend is up"
              exit 0
            fi

            if [ -f /tmp/backend.pid ] && ! kill -0 "$(cat /tmp/backend.pid)" 2>/dev/null; then
              echo "Backend process is not running anymore!"
              echo "----- listening ports -----"
              ss -lntp || true
              echo "----- backend log -----"
              cat /tmp/backend.log || true
              exit 1
            fi

            sleep 2
          done

          echo "Backend failed to start"
          echo "----- listening ports -----"
          ss -lntp || true
          echo "----- backend log -----"
          cat /tmp/backend.log || true
          exit 1

      - name: Start frontend (build + preview)
        working-directory: frontend
        run: |
          npm run build
          nohup npm run preview -- --host 0.0.0.0 --port 5173 --strictPort > /tmp/frontend.log 2>&1 &
          echo $! > /tmp/frontend.pid
          sleep 1
          echo "Frontend PID: $(cat /tmp/frontend.pid)"
          ps -p "$(cat /tmp/frontend.pid)" -o pid,cmd || true
          tail -n 120 /tmp/frontend.log || true

      - name: Wait for frontend
        run: |
          for i in {1..60}; do
            if curl -4 -sSf http://127.0.0.1:5173/ >/dev/null; then
              echo "Frontend is up"
              exit 0
            fi

            if [ -f /tmp/frontend.pid ] && ! kill -0 "$(cat /tmp/frontend.pid)" 2>/dev/null; then
              echo "Frontend process is not running anymore!"
              echo "----- listening ports -----"
              ss -lntp || true
              echo "----- frontend log -----"
              cat /tmp/frontend.log || true
              exit 1
            fi

            sleep 2
          done

          echo "Frontend failed to start"
          echo "----- listening ports -----"
          ss -lntp || true
          echo "----- frontend log -----"
          cat /tmp/frontend.log || true
          exit 1

      - name: Prepare artifact folders
        working-directory: automation
        run: mkdir -p test-results playwright-report

      - name: Run Playwright (real DB)
        working-directory: automation
        run: npx playwright test --project=chromium --reporter=html,line

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-real
          path: automation/playwright-report/
          retention-days: 30

      - name: Upload test results (screenshots/videos/traces)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-real
          path: automation/test-results/
          if-no-files-found: ignore
          retention-days: 14
